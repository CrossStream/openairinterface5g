/*******************************************************************************
    OpenAirInterface
    Copyright(c) 1999 - 2014 Eurecom

    OpenAirInterface is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.


    OpenAirInterface is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with OpenAirInterface.The full GNU General Public License is
   included in this distribution in the file called "COPYING". If not,
   see <http://www.gnu.org/licenses/>.

  Contact Information
  OpenAirInterface Admin: openair_admin@eurecom.fr
  OpenAirInterface Tech : openair_tech@eurecom.fr
  OpenAirInterface Dev  : openair4g-devel@eurecom.fr

  Address      : Eurecom, Campus SophiaTech, 450 Route des Chappes, CS 50193 - 06904 Biot Sophia Antipolis cedex, FRANCE

 *******************************************************************************/
#include "defs.h"
#include "PHY/defs.h"
#include "log.h"

#include <stdlib.h>
#include <stdint.h>
#include <string.h>
#include <math.h>
#include <stdio.h>
#define PI 3.141592654

int16_t cos_tab_128[128] = {32767,32727,32609,32412,32137,31785,31356,30851,30272,29621,28897,28105,27244,26318,25329,24278,23169,22004,20787,19519,18204,16845,15446,14009,12539,11038,9511,7961,6392,4807,3211,1607,0,-1607,-3211,-4807,-6392,-7961,-9511,-11038,-12539,-14009,-15446,-16845,-18204,-19519,-20787,-22004,-23169,-24278,-25329,-26318,-27244,-28105,-28897,-29621,-30272,-30851,-31356,-31785,-32137,-32412,-32609,-32727,-32767,-32727,-32609,-32412,-32137,-31785,-31356,-30851,-30272,-29621,-28897,-28105,-27244,-26318,-25329,-24278,-23169,-22004,-20787,-19519,-18204,-16845,-15446,-14009,-12539,-11038,-9511,-7961,-6392,-4807,-3211,-1607,0,1607,3211,4807,6392,7961,9511,11038,12539,14009,15446,16845,18204,19519,20787,22004,23169,24278,25329,26318,27244,28105,28897,29621,30272,30851,31356,31785,32137,32412,32609,32727};

int16_t cos_tab_256[256] = {32767,32757,32727,32678,32609,32520,32412,32284,32137,31970,31785,31580,31356,31113,30851,30571,30272,29955,29621,29268,28897,28510,28105,27683,27244,26789,26318,25831,25329,24811,24278,23731,23169,22594,22004,21402,20787,20159,19519,18867,18204,17530,16845,16150,15446,14732,14009,13278,12539,11792,11038,10278,9511,8739,7961,7179,6392,5601,4807,4011,3211,2410,1607,804,0,-804,-1607,-2410,-3211,-4011,-4807,-5601,-6392,-7179,-7961,-8739,-9511,-10278,-11038,-11792,-12539,-13278,-14009,-14732,-15446,-16150,-16845,-17530,-18204,-18867,-19519,-20159,-20787,-21402,-22004,-22594,-23169,-23731,-24278,-24811,-25329,-25831,-26318,-26789,-27244,-27683,-28105,-28510,-28897,-29268,-29621,-29955,-30272,-30571,-30851,-31113,-31356,-31580,-31785,-31970,-32137,-32284,-32412,-32520,-32609,-32678,-32727,-32757,-32767,-32757,-32727,-32678,-32609,-32520,-32412,-32284,-32137,-31970,-31785,-31580,-31356,-31113,-30851,-30571,-30272,-29955,-29621,-29268,-28897,-28510,-28105,-27683,-27244,-26789,-26318,-25831,-25329,-24811,-24278,-23731,-23169,-22594,-22004,-21402,-20787,-20159,-19519,-18867,-18204,-17530,-16845,-16150,-15446,-14732,-14009,-13278,-12539,-11792,-11038,-10278,-9511,-8739,-7961,-7179,-6392,-5601,-4807,-4011,-3211,-2410,-1607,-804,0,804,1607,2410,3211,4011,4807,5601,6392,7179,7961,8739,9511,10278,11038,11792,12539,13278,14009,14732,15446,16150,16845,17530,18204,18867,19519,20159,20787,21402,22004,22594,23169,23731,24278,24811,25329,25831,26318,26789,27244,27683,28105,28510,28897,29268,29621,29955,30272,30571,30851,31113,31356,31580,31785,31970,32137,32284,32412,32520,32609,32678,32727,32757};

int16_t cos_tab_512[512] = {32767,32764,32757,32744,32727,32705,32678,32646,32609,32567,32520,32468,32412,32350,32284,32213,32137,32056,31970,31880,31785,31684,31580,31470,31356,31236,31113,30984,30851,30713,30571,30424,30272,30116,29955,29790,29621,29446,29268,29085,28897,28706,28510,28309,28105,27896,27683,27466,27244,27019,26789,26556,26318,26077,25831,25582,25329,25072,24811,24546,24278,24006,23731,23452,23169,22883,22594,22301,22004,21705,21402,21096,20787,20474,20159,19840,19519,19194,18867,18537,18204,17868,17530,17189,16845,16499,16150,15799,15446,15090,14732,14372,14009,13645,13278,12909,12539,12166,11792,11416,11038,10659,10278,9895,9511,9126,8739,8351,7961,7571,7179,6786,6392,5997,5601,5205,4807,4409,4011,3611,3211,2811,2410,2009,1607,1206,804,402,0,-402,-804,-1206,-1607,-2009,-2410,-2811,-3211,-3611,-4011,-4409,-4807,-5205,-5601,-5997,-6392,-6786,-7179,-7571,-7961,-8351,-8739,-9126,-9511,-9895,-10278,-10659,-11038,-11416,-11792,-12166,-12539,-12909,-13278,-13645,-14009,-14372,-14732,-15090,-15446,-15799,-16150,-16499,-16845,-17189,-17530,-17868,-18204,-18537,-18867,-19194,-19519,-19840,-20159,-20474,-20787,-21096,-21402,-21705,-22004,-22301,-22594,-22883,-23169,-23452,-23731,-24006,-24278,-24546,-24811,-25072,-25329,-25582,-25831,-26077,-26318,-26556,-26789,-27019,-27244,-27466,-27683,-27896,-28105,-28309,-28510,-28706,-28897,-29085,-29268,-29446,-29621,-29790,-29955,-30116,-30272,-30424,-30571,-30713,-30851,-30984,-31113,-31236,-31356,-31470,-31580,-31684,-31785,-31880,-31970,-32056,-32137,-32213,-32284,-32350,-32412,-32468,-32520,-32567,-32609,-32646,-32678,-32705,-32727,-32744,-32757,-32764,-32767,-32764,-32757,-32744,-32727,-32705,-32678,-32646,-32609,-32567,-32520,-32468,-32412,-32350,-32284,-32213,-32137,-32056,-31970,-31880,-31785,-31684,-31580,-31470,-31356,-31236,-31113,-30984,-30851,-30713,-30571,-30424,-30272,-30116,-29955,-29790,-29621,-29446,-29268,-29085,-28897,-28706,-28510,-28309,-28105,-27896,-27683,-27466,-27244,-27019,-26789,-26556,-26318,-26077,-25831,-25582,-25329,-25072,-24811,-24546,-24278,-24006,-23731,-23452,-23169,-22883,-22594,-22301,-22004,-21705,-21402,-21096,-20787,-20474,-20159,-19840,-19519,-19194,-18867,-18537,-18204,-17868,-17530,-17189,-16845,-16499,-16150,-15799,-15446,-15090,-14732,-14372,-14009,-13645,-13278,-12909,-12539,-12166,-11792,-11416,-11038,-10659,-10278,-9895,-9511,-9126,-8739,-8351,-7961,-7571,-7179,-6786,-6392,-5997,-5601,-5205,-4807,-4409,-4011,-3611,-3211,-2811,-2410,-2009,-1607,-1206,-804,-402,0,402,804,1206,1607,2009,2410,2811,3211,3611,4011,4409,4807,5205,5601,5997,6392,6786,7179,7571,7961,8351,8739,9126,9511,9895,10278,10659,11038,11416,11792,12166,12539,12909,13278,13645,14009,14372,14732,15090,15446,15799,16150,16499,16845,17189,17530,17868,18204,18537,18867,19194,19519,19840,20159,20474,20787,21096,21402,21705,22004,22301,22594,22883,23169,23452,23731,24006,24278,24546,24811,25072,25329,25582,25831,26077,26318,26556,26789,27019,27244,27466,27683,27896,28105,28309,28510,28706,28897,29085,29268,29446,29621,29790,29955,30116,30272,30424,30571,30713,30851,30984,31113,31236,31356,31470,31580,31684,31785,31880,31970,32056,32137,32213,32284,32350,32412,32468,32520,32567,32609,32646,32678,32705,32727,32744,32757,32764};

int16_t cos_tab_1024[1024] = {32767,32766,32764,32761,32757,32751,32744,32736,32727,32717,32705,32692,32678,32662,32646,32628,32609,32588,32567,32544,32520,32495,32468,32441,32412,32382,32350,32318,32284,32249,32213,32176,32137,32097,32056,32014,31970,31926,31880,31833,31785,31735,31684,31633,31580,31525,31470,31413,31356,31297,31236,31175,31113,31049,30984,30918,30851,30783,30713,30643,30571,30498,30424,30349,30272,30195,30116,30036,29955,29873,29790,29706,29621,29534,29446,29358,29268,29177,29085,28992,28897,28802,28706,28608,28510,28410,28309,28208,28105,28001,27896,27790,27683,27575,27466,27355,27244,27132,27019,26905,26789,26673,26556,26437,26318,26198,26077,25954,25831,25707,25582,25456,25329,25201,25072,24942,24811,24679,24546,24413,24278,24143,24006,23869,23731,23592,23452,23311,23169,23027,22883,22739,22594,22448,22301,22153,22004,21855,21705,21554,21402,21249,21096,20942,20787,20631,20474,20317,20159,20000,19840,19680,19519,19357,19194,19031,18867,18702,18537,18371,18204,18036,17868,17699,17530,17360,17189,17017,16845,16672,16499,16325,16150,15975,15799,15623,15446,15268,15090,14911,14732,14552,14372,14191,14009,13827,13645,13462,13278,13094,12909,12724,12539,12353,12166,11980,11792,11604,11416,11227,11038,10849,10659,10469,10278,10087,9895,9703,9511,9319,9126,8932,8739,8545,8351,8156,7961,7766,7571,7375,7179,6982,6786,6589,6392,6195,5997,5799,5601,5403,5205,5006,4807,4608,4409,4210,4011,3811,3611,3411,3211,3011,2811,2610,2410,2209,2009,1808,1607,1406,1206,1005,804,603,402,201,0,-202,-403,-604,-805,-1006,-1207,-1407,-1608,-1809,-2010,-2210,-2411,-2611,-2812,-3012,-3212,-3412,-3612,-3812,-4012,-4211,-4410,-4609,-4808,-5007,-5206,-5404,-5602,-5800,-5998,-6196,-6393,-6590,-6787,-6983,-7180,-7376,-7572,-7767,-7962,-8157,-8352,-8546,-8740,-8933,-9127,-9320,-9512,-9704,-9896,-10088,-10279,-10470,-10660,-10850,-11039,-11228,-11417,-11605,-11793,-11981,-12167,-12354,-12540,-12725,-12910,-13095,-13279,-13463,-13646,-13828,-14010,-14192,-14373,-14553,-14733,-14912,-15091,-15269,-15447,-15624,-15800,-15976,-16151,-16326,-16500,-16673,-16846,-17018,-17190,-17361,-17531,-17700,-17869,-18037,-18205,-18372,-18538,-18703,-18868,-19032,-19195,-19358,-19520,-19681,-19841,-20001,-20160,-20318,-20475,-20632,-20788,-20943,-21097,-21250,-21403,-21555,-21706,-21856,-22005,-22154,-22302,-22449,-22595,-22740,-22884,-23028,-23170,-23312,-23453,-23593,-23732,-23870,-24007,-24144,-24279,-24414,-24547,-24680,-24812,-24943,-25073,-25202,-25330,-25457,-25583,-25708,-25832,-25955,-26078,-26199,-26319,-26438,-26557,-26674,-26790,-26906,-27020,-27133,-27245,-27356,-27467,-27576,-27684,-27791,-27897,-28002,-28106,-28209,-28310,-28411,-28511,-28609,-28707,-28803,-28898,-28993,-29086,-29178,-29269,-29359,-29447,-29535,-29622,-29707,-29791,-29874,-29956,-30037,-30117,-30196,-30273,-30350,-30425,-30499,-30572,-30644,-30714,-30784,-30852,-30919,-30985,-31050,-31114,-31176,-31237,-31298,-31357,-31414,-31471,-31526,-31581,-31634,-31685,-31736,-31786,-31834,-31881,-31927,-31971,-32015,-32057,-32098,-32138,-32177,-32214,-32250,-32285,-32319,-32351,-32383,-32413,-32442,-32469,-32496,-32521,-32545,-32568,-32589,-32610,-32629,-32647,-32663,-32679,-32693,-32706,-32718,-32728,-32737,-32745,-32752,-32758,-32762,-32765,-32767,-32767,-32767,-32765,-32762,-32758,-32752,-32745,-32737,-32728,-32718,-32706,-32693,-32679,-32663,-32647,-32629,-32610,-32589,-32568,-32545,-32521,-32496,-32469,-32442,-32413,-32383,-32351,-32319,-32285,-32250,-32214,-32177,-32138,-32098,-32057,-32015,-31971,-31927,-31881,-31834,-31786,-31736,-31685,-31634,-31581,-31526,-31471,-31414,-31357,-31298,-31237,-31176,-31114,-31050,-30985,-30919,-30852,-30784,-30714,-30644,-30572,-30499,-30425,-30350,-30273,-30196,-30117,-30037,-29956,-29874,-29791,-29707,-29622,-29535,-29447,-29359,-29269,-29178,-29086,-28993,-28898,-28803,-28707,-28609,-28511,-28411,-28310,-28209,-28106,-28002,-27897,-27791,-27684,-27576,-27467,-27356,-27245,-27133,-27020,-26906,-26790,-26674,-26557,-26438,-26319,-26199,-26078,-25955,-25832,-25708,-25583,-25457,-25330,-25202,-25073,-24943,-24812,-24680,-24547,-24414,-24279,-24144,-24007,-23870,-23732,-23593,-23453,-23312,-23170,-23028,-22884,-22740,-22595,-22449,-22302,-22154,-22005,-21856,-21706,-21555,-21403,-21250,-21097,-20943,-20788,-20632,-20475,-20318,-20160,-20001,-19841,-19681,-19520,-19358,-19195,-19032,-18868,-18703,-18538,-18372,-18205,-18037,-17869,-17700,-17531,-17361,-17190,-17018,-16846,-16673,-16500,-16326,-16151,-15976,-15800,-15624,-15447,-15269,-15091,-14912,-14733,-14553,-14373,-14192,-14010,-13828,-13646,-13463,-13279,-13095,-12910,-12725,-12540,-12354,-12167,-11981,-11793,-11605,-11417,-11228,-11039,-10850,-10660,-10470,-10279,-10088,-9896,-9704,-9512,-9320,-9127,-8933,-8740,-8546,-8352,-8157,-7962,-7767,-7572,-7376,-7180,-6983,-6787,-6590,-6393,-6196,-5998,-5800,-5602,-5404,-5206,-5007,-4808,-4609,-4410,-4211,-4012,-3812,-3612,-3412,-3212,-3012,-2812,-2611,-2411,-2210,-2010,-1809,-1608,-1407,-1207,-1006,-805,-604,-403,-202,-1,201,402,603,804,1005,1206,1406,1607,1808,2009,2209,2410,2610,2811,3011,3211,3411,3611,3811,4011,4210,4409,4608,4807,5006,5205,5403,5601,5799,5997,6195,6392,6589,6786,6982,7179,7375,7571,7766,7961,8156,8351,8545,8739,8932,9126,9319,9511,9703,9895,10087,10278,10469,10659,10849,11038,11227,11416,11604,11792,11980,12166,12353,12539,12724,12909,13094,13278,13462,13645,13827,14009,14191,14372,14552,14732,14911,15090,15268,15446,15623,15799,15975,16150,16325,16499,16672,16845,17017,17189,17360,17530,17699,17868,18036,18204,18371,18537,18702,18867,19031,19194,19357,19519,19680,19840,20000,20159,20317,20474,20631,20787,20942,21096,21249,21402,21554,21705,21855,22004,22153,22301,22448,22594,22739,22883,23027,23169,23311,23452,23592,23731,23869,24006,24143,24278,24413,24546,24679,24811,24942,25072,25201,25329,25456,25582,25707,25831,25954,26077,26198,26318,26437,26556,26673,26789,26905,27019,27132,27244,27355,27466,27575,27683,27790,27896,28001,28105,28208,28309,28410,28510,28608,28706,28802,28897,28992,29085,29177,29268,29358,29446,29534,29621,29706,29790,29873,29955,30036,30116,30195,30272,30349,30424,30498,30571,30643,30713,30783,30851,30918,30984,31049,31113,31175,31236,31297,31356,31413,31470,31525,31580,31633,31684,31735,31785,31833,31880,31926,31970,32014,32056,32097,32137,32176,32213,32249,32284,32318,32350,32382,32412,32441,32468,32495,32520,32544,32567,32588,32609,32628,32646,32662,32678,32692,32705,32717,32727,32736,32744,32751,32757,32761,32764,32766};

int16_t cos_tab_1536[1536] = {32767,32766,32765,32764,32762,32760,32757,32753,32749,32744,32739,32733,32727,32720,32713,32705,32696,32687,32678,32668,32657,32646,32634,32622,32609,32595,32581,32567,32552,32536,32520,32503,32486,32468,32450,32431,32412,32392,32371,32350,32329,32307,32284,32261,32237,32213,32188,32163,32137,32110,32084,32056,32028,31999,31970,31941,31911,31880,31849,31817,31785,31752,31718,31684,31650,31615,31580,31544,31507,31470,31432,31394,31356,31316,31277,31236,31196,31154,31113,31070,31028,30984,30940,30896,30851,30806,30760,30713,30666,30619,30571,30522,30473,30424,30374,30323,30272,30221,30169,30116,30063,30009,29955,29901,29846,29790,29734,29678,29621,29563,29505,29446,29387,29328,29268,29207,29146,29085,29023,28960,28897,28834,28770,28706,28641,28575,28510,28443,28377,28309,28242,28173,28105,28036,27966,27896,27825,27754,27683,27611,27538,27466,27392,27319,27244,27170,27094,27019,26943,26866,26789,26712,26634,26556,26477,26398,26318,26238,26158,26077,25995,25913,25831,25749,25665,25582,25498,25414,25329,25243,25158,25072,24985,24898,24811,24723,24635,24546,24457,24368,24278,24188,24097,24006,23915,23823,23731,23638,23545,23452,23358,23264,23169,23074,22979,22883,22787,22691,22594,22496,22399,22301,22202,22104,22004,21905,21805,21705,21604,21503,21402,21300,21198,21096,20993,20890,20787,20683,20579,20474,20369,20264,20159,20053,19947,19840,19733,19626,19519,19411,19303,19194,19086,18976,18867,18757,18647,18537,18426,18315,18204,18092,17980,17868,17756,17643,17530,17416,17303,17189,17074,16960,16845,16730,16615,16499,16383,16267,16150,16034,15917,15799,15682,15564,15446,15327,15209,15090,14971,14852,14732,14612,14492,14372,14251,14130,14009,13888,13766,13645,13523,13400,13278,13155,13033,12909,12786,12663,12539,12415,12291,12166,12042,11917,11792,11667,11542,11416,11290,11164,11038,10912,10786,10659,10532,10405,10278,10151,10023,9895,9767,9639,9511,9383,9254,9126,8997,8868,8739,8610,8480,8351,8221,8091,7961,7831,7701,7571,7440,7310,7179,7048,6917,6786,6655,6523,6392,6261,6129,5997,5865,5733,5601,5469,5337,5205,5072,4940,4807,4675,4542,4409,4276,4144,4011,3877,3744,3611,3478,3345,3211,3078,2944,2811,2677,2544,2410,2276,2143,2009,1875,1741,1607,1473,1339,1206,1072,938,804,670,536,402,268,134,0,-134,-268,-402,-536,-670,-804,-938,-1072,-1206,-1339,-1473,-1607,-1741,-1875,-2009,-2143,-2276,-2410,-2544,-2677,-2811,-2944,-3078,-3211,-3345,-3478,-3611,-3744,-3877,-4011,-4144,-4276,-4409,-4542,-4675,-4807,-4940,-5072,-5205,-5337,-5469,-5601,-5733,-5865,-5997,-6129,-6261,-6392,-6523,-6655,-6786,-6917,-7048,-7179,-7310,-7440,-7571,-7701,-7831,-7961,-8091,-8221,-8351,-8480,-8610,-8739,-8868,-8997,-9126,-9254,-9383,-9511,-9639,-9767,-9895,-10023,-10151,-10278,-10405,-10532,-10659,-10786,-10912,-11038,-11164,-11290,-11416,-11542,-11667,-11792,-11917,-12042,-12166,-12291,-12415,-12539,-12663,-12786,-12909,-13033,-13155,-13278,-13400,-13523,-13645,-13766,-13888,-14009,-14130,-14251,-14372,-14492,-14612,-14732,-14852,-14971,-15090,-15209,-15327,-15446,-15564,-15682,-15799,-15917,-16034,-16150,-16267,-16383,-16499,-16615,-16730,-16845,-16960,-17074,-17189,-17303,-17416,-17530,-17643,-17756,-17868,-17980,-18092,-18204,-18315,-18426,-18537,-18647,-18757,-18867,-18976,-19086,-19194,-19303,-19411,-19519,-19626,-19733,-19840,-19947,-20053,-20159,-20264,-20369,-20474,-20579,-20683,-20787,-20890,-20993,-21096,-21198,-21300,-21402,-21503,-21604,-21705,-21805,-21905,-22004,-22104,-22202,-22301,-22399,-22496,-22594,-22691,-22787,-22883,-22979,-23074,-23169,-23264,-23358,-23452,-23545,-23638,-23731,-23823,-23915,-24006,-24097,-24188,-24278,-24368,-24457,-24546,-24635,-24723,-24811,-24898,-24985,-25072,-25158,-25243,-25329,-25414,-25498,-25582,-25665,-25749,-25831,-25913,-25995,-26077,-26158,-26238,-26318,-26398,-26477,-26556,-26634,-26712,-26789,-26866,-26943,-27019,-27094,-27170,-27244,-27319,-27392,-27466,-27538,-27611,-27683,-27754,-27825,-27896,-27966,-28036,-28105,-28173,-28242,-28309,-28377,-28443,-28510,-28575,-28641,-28706,-28770,-28834,-28897,-28960,-29023,-29085,-29146,-29207,-29268,-29328,-29387,-29446,-29505,-29563,-29621,-29678,-29734,-29790,-29846,-29901,-29955,-30009,-30063,-30116,-30169,-30221,-30272,-30323,-30374,-30424,-30473,-30522,-30571,-30619,-30666,-30713,-30760,-30806,-30851,-30896,-30940,-30984,-31028,-31070,-31113,-31154,-31196,-31236,-31277,-31316,-31356,-31394,-31432,-31470,-31507,-31544,-31580,-31615,-31650,-31684,-31718,-31752,-31785,-31817,-31849,-31880,-31911,-31941,-31970,-31999,-32028,-32056,-32084,-32110,-32137,-32163,-32188,-32213,-32237,-32261,-32284,-32307,-32329,-32350,-32371,-32392,-32412,-32431,-32450,-32468,-32486,-32503,-32520,-32536,-32552,-32567,-32581,-32595,-32609,-32622,-32634,-32646,-32657,-32668,-32678,-32687,-32696,-32705,-32713,-32720,-32727,-32733,-32739,-32744,-32749,-32753,-32757,-32760,-32762,-32764,-32765,-32766,-32767,-32766,-32765,-32764,-32762,-32760,-32757,-32753,-32749,-32744,-32739,-32733,-32727,-32720,-32713,-32705,-32696,-32687,-32678,-32668,-32657,-32646,-32634,-32622,-32609,-32595,-32581,-32567,-32552,-32536,-32520,-32503,-32486,-32468,-32450,-32431,-32412,-32392,-32371,-32350,-32329,-32307,-32284,-32261,-32237,-32213,-32188,-32163,-32137,-32110,-32084,-32056,-32028,-31999,-31970,-31941,-31911,-31880,-31849,-31817,-31785,-31752,-31718,-31684,-31650,-31615,-31580,-31544,-31507,-31470,-31432,-31394,-31356,-31316,-31277,-31236,-31196,-31154,-31113,-31070,-31028,-30984,-30940,-30896,-30851,-30806,-30760,-30713,-30666,-30619,-30571,-30522,-30473,-30424,-30374,-30323,-30272,-30221,-30169,-30116,-30063,-30009,-29955,-29901,-29846,-29790,-29734,-29678,-29621,-29563,-29505,-29446,-29387,-29328,-29268,-29207,-29146,-29085,-29023,-28960,-28897,-28834,-28770,-28706,-28641,-28575,-28510,-28443,-28377,-28309,-28242,-28173,-28105,-28036,-27966,-27896,-27825,-27754,-27683,-27611,-27538,-27466,-27392,-27319,-27244,-27170,-27094,-27019,-26943,-26866,-26789,-26712,-26634,-26556,-26477,-26398,-26318,-26238,-26158,-26077,-25995,-25913,-25831,-25749,-25665,-25582,-25498,-25414,-25329,-25243,-25158,-25072,-24985,-24898,-24811,-24723,-24635,-24546,-24457,-24368,-24278,-24188,-24097,-24006,-23915,-23823,-23731,-23638,-23545,-23452,-23358,-23264,-23169,-23074,-22979,-22883,-22787,-22691,-22594,-22496,-22399,-22301,-22202,-22104,-22004,-21905,-21805,-21705,-21604,-21503,-21402,-21300,-21198,-21096,-20993,-20890,-20787,-20683,-20579,-20474,-20369,-20264,-20159,-20053,-19947,-19840,-19733,-19626,-19519,-19411,-19303,-19194,-19086,-18976,-18867,-18757,-18647,-18537,-18426,-18315,-18204,-18092,-17980,-17868,-17756,-17643,-17530,-17416,-17303,-17189,-17074,-16960,-16845,-16730,-16615,-16499,-16383,-16267,-16150,-16034,-15917,-15799,-15682,-15564,-15446,-15327,-15209,-15090,-14971,-14852,-14732,-14612,-14492,-14372,-14251,-14130,-14009,-13888,-13766,-13645,-13523,-13400,-13278,-13155,-13033,-12909,-12786,-12663,-12539,-12415,-12291,-12166,-12042,-11917,-11792,-11667,-11542,-11416,-11290,-11164,-11038,-10912,-10786,-10659,-10532,-10405,-10278,-10151,-10023,-9895,-9767,-9639,-9511,-9383,-9254,-9126,-8997,-8868,-8739,-8610,-8480,-8351,-8221,-8091,-7961,-7831,-7701,-7571,-7440,-7310,-7179,-7048,-6917,-6786,-6655,-6523,-6392,-6261,-6129,-5997,-5865,-5733,-5601,-5469,-5337,-5205,-5072,-4940,-4807,-4675,-4542,-4409,-4276,-4144,-4011,-3877,-3744,-3611,-3478,-3345,-3211,-3078,-2944,-2811,-2677,-2544,-2410,-2276,-2143,-2009,-1875,-1741,-1607,-1473,-1339,-1206,-1072,-938,-804,-670,-536,-402,-268,-134,0,134,268,402,536,670,804,938,1072,1206,1339,1473,1607,1741,1875,2009,2143,2276,2410,2544,2677,2811,2944,3078,3211,3345,3478,3611,3744,3877,4011,4144,4276,4409,4542,4675,4807,4940,5072,5205,5337,5469,5601,5733,5865,5997,6129,6261,6392,6523,6655,6786,6917,7048,7179,7310,7440,7571,7701,7831,7961,8091,8221,8351,8480,8610,8739,8868,8997,9126,9254,9383,9511,9639,9767,9895,10023,10151,10278,10405,10532,10659,10786,10912,11038,11164,11290,11416,11542,11667,11792,11917,12042,12166,12291,12415,12539,12663,12786,12909,13033,13155,13278,13400,13523,13645,13766,13888,14009,14130,14251,14372,14492,14612,14732,14852,14971,15090,15209,15327,15446,15564,15682,15799,15917,16034,16150,16267,16383,16499,16615,16730,16845,16960,17074,17189,17303,17416,17530,17643,17756,17868,17980,18092,18204,18315,18426,18537,18647,18757,18867,18976,19086,19194,19303,19411,19519,19626,19733,19840,19947,20053,20159,20264,20369,20474,20579,20683,20787,20890,20993,21096,21198,21300,21402,21503,21604,21705,21805,21905,22004,22104,22202,22301,22399,22496,22594,22691,22787,22883,22979,23074,23169,23264,23358,23452,23545,23638,23731,23823,23915,24006,24097,24188,24278,24368,24457,24546,24635,24723,24811,24898,24985,25072,25158,25243,25329,25414,25498,25582,25665,25749,25831,25913,25995,26077,26158,26238,26318,26398,26477,26556,26634,26712,26789,26866,26943,27019,27094,27170,27244,27319,27392,27466,27538,27611,27683,27754,27825,27896,27966,28036,28105,28173,28242,28309,28377,28443,28510,28575,28641,28706,28770,28834,28897,28960,29023,29085,29146,29207,29268,29328,29387,29446,29505,29563,29621,29678,29734,29790,29846,29901,29955,30009,30063,30116,30169,30221,30272,30323,30374,30424,30473,30522,30571,30619,30666,30713,30760,30806,30851,30896,30940,30984,31028,31070,31113,31154,31196,31236,31277,31316,31356,31394,31432,31470,31507,31544,31580,31615,31650,31684,31718,31752,31785,31817,31849,31880,31911,31941,31970,31999,32028,32056,32084,32110,32137,32163,32188,32213,32237,32261,32284,32307,32329,32350,32371,32392,32412,32431,32450,32468,32486,32503,32520,32536,32552,32567,32581,32595,32609,32622,32634,32646,32657,32668,32678,32687,32696,32705,32713,32720,32727,32733,32739,32744,32749,32753,32757,32760,32762,32764,32765,32766};

int16_t cos_tab_2048[2048] = {32767,32766,32766,32765,32764,32763,32761,32759,32757,32754,32751,32748,32744,32740,32736,32732,32727,32722,32717,32711,32705,32699,32692,32685,32678,32670,32662,32654,32646,32637,32628,32618,32609,32599,32588,32578,32567,32556,32544,32532,32520,32508,32495,32482,32468,32455,32441,32426,32412,32397,32382,32366,32350,32334,32318,32301,32284,32267,32249,32231,32213,32194,32176,32156,32137,32117,32097,32077,32056,32035,32014,31992,31970,31948,31926,31903,31880,31856,31833,31809,31785,31760,31735,31710,31684,31659,31633,31606,31580,31553,31525,31498,31470,31442,31413,31385,31356,31326,31297,31267,31236,31206,31175,31144,31113,31081,31049,31017,30984,30951,30918,30885,30851,30817,30783,30748,30713,30678,30643,30607,30571,30535,30498,30461,30424,30386,30349,30311,30272,30234,30195,30156,30116,30076,30036,29996,29955,29915,29873,29832,29790,29748,29706,29663,29621,29577,29534,29490,29446,29402,29358,29313,29268,29222,29177,29131,29085,29038,28992,28945,28897,28850,28802,28754,28706,28657,28608,28559,28510,28460,28410,28360,28309,28259,28208,28156,28105,28053,28001,27948,27896,27843,27790,27736,27683,27629,27575,27520,27466,27411,27355,27300,27244,27188,27132,27076,27019,26962,26905,26847,26789,26731,26673,26615,26556,26497,26437,26378,26318,26258,26198,26137,26077,26016,25954,25893,25831,25769,25707,25645,25582,25519,25456,25392,25329,25265,25201,25136,25072,25007,24942,24877,24811,24745,24679,24613,24546,24480,24413,24346,24278,24211,24143,24075,24006,23938,23869,23800,23731,23661,23592,23522,23452,23382,23311,23240,23169,23098,23027,22955,22883,22811,22739,22666,22594,22521,22448,22374,22301,22227,22153,22079,22004,21930,21855,21780,21705,21629,21554,21478,21402,21326,21249,21173,21096,21019,20942,20864,20787,20709,20631,20553,20474,20396,20317,20238,20159,20079,20000,19920,19840,19760,19680,19599,19519,19438,19357,19276,19194,19113,19031,18949,18867,18785,18702,18620,18537,18454,18371,18287,18204,18120,18036,17952,17868,17784,17699,17615,17530,17445,17360,17274,17189,17103,17017,16931,16845,16759,16672,16586,16499,16412,16325,16238,16150,16063,15975,15887,15799,15711,15623,15534,15446,15357,15268,15179,15090,15001,14911,14822,14732,14642,14552,14462,14372,14281,14191,14100,14009,13918,13827,13736,13645,13553,13462,13370,13278,13186,13094,13002,12909,12817,12724,12632,12539,12446,12353,12260,12166,12073,11980,11886,11792,11698,11604,11510,11416,11322,11227,11133,11038,10944,10849,10754,10659,10564,10469,10373,10278,10182,10087,9991,9895,9799,9703,9607,9511,9415,9319,9222,9126,9029,8932,8836,8739,8642,8545,8448,8351,8253,8156,8059,7961,7864,7766,7668,7571,7473,7375,7277,7179,7081,6982,6884,6786,6688,6589,6491,6392,6293,6195,6096,5997,5898,5799,5700,5601,5502,5403,5304,5205,5106,5006,4907,4807,4708,4608,4509,4409,4310,4210,4110,4011,3911,3811,3711,3611,3511,3411,3311,3211,3111,3011,2911,2811,2711,2610,2510,2410,2310,2209,2109,2009,1908,1808,1708,1607,1507,1406,1306,1206,1105,1005,904,804,703,603,502,402,301,201,100,0,-100,-201,-301,-402,-502,-603,-703,-804,-904,-1005,-1105,-1206,-1306,-1406,-1507,-1607,-1708,-1808,-1908,-2009,-2109,-2209,-2310,-2410,-2510,-2610,-2711,-2811,-2911,-3011,-3111,-3211,-3311,-3411,-3511,-3611,-3711,-3811,-3911,-4011,-4110,-4210,-4310,-4409,-4509,-4608,-4708,-4807,-4907,-5006,-5106,-5205,-5304,-5403,-5502,-5601,-5700,-5799,-5898,-5997,-6096,-6195,-6293,-6392,-6491,-6589,-6688,-6786,-6884,-6982,-7081,-7179,-7277,-7375,-7473,-7571,-7668,-7766,-7864,-7961,-8059,-8156,-8253,-8351,-8448,-8545,-8642,-8739,-8836,-8932,-9029,-9126,-9222,-9319,-9415,-9511,-9607,-9703,-9799,-9895,-9991,-10087,-10182,-10278,-10373,-10469,-10564,-10659,-10754,-10849,-10944,-11038,-11133,-11227,-11322,-11416,-11510,-11604,-11698,-11792,-11886,-11980,-12073,-12166,-12260,-12353,-12446,-12539,-12632,-12724,-12817,-12909,-13002,-13094,-13186,-13278,-13370,-13462,-13553,-13645,-13736,-13827,-13918,-14009,-14100,-14191,-14281,-14372,-14462,-14552,-14642,-14732,-14822,-14911,-15001,-15090,-15179,-15268,-15357,-15446,-15534,-15623,-15711,-15799,-15887,-15975,-16063,-16150,-16238,-16325,-16412,-16499,-16586,-16672,-16759,-16845,-16931,-17017,-17103,-17189,-17274,-17360,-17445,-17530,-17615,-17699,-17784,-17868,-17952,-18036,-18120,-18204,-18287,-18371,-18454,-18537,-18620,-18702,-18785,-18867,-18949,-19031,-19113,-19194,-19276,-19357,-19438,-19519,-19599,-19680,-19760,-19840,-19920,-20000,-20079,-20159,-20238,-20317,-20396,-20474,-20553,-20631,-20709,-20787,-20864,-20942,-21019,-21096,-21173,-21249,-21326,-21402,-21478,-21554,-21629,-21705,-21780,-21855,-21930,-22004,-22079,-22153,-22227,-22301,-22374,-22448,-22521,-22594,-22666,-22739,-22811,-22883,-22955,-23027,-23098,-23169,-23240,-23311,-23382,-23452,-23522,-23592,-23661,-23731,-23800,-23869,-23938,-24006,-24075,-24143,-24211,-24278,-24346,-24413,-24480,-24546,-24613,-24679,-24745,-24811,-24877,-24942,-25007,-25072,-25136,-25201,-25265,-25329,-25392,-25456,-25519,-25582,-25645,-25707,-25769,-25831,-25893,-25954,-26016,-26077,-26137,-26198,-26258,-26318,-26378,-26437,-26497,-26556,-26615,-26673,-26731,-26789,-26847,-26905,-26962,-27019,-27076,-27132,-27188,-27244,-27300,-27355,-27411,-27466,-27520,-27575,-27629,-27683,-27736,-27790,-27843,-27896,-27948,-28001,-28053,-28105,-28156,-28208,-28259,-28309,-28360,-28410,-28460,-28510,-28559,-28608,-28657,-28706,-28754,-28802,-28850,-28897,-28945,-28992,-29038,-29085,-29131,-29177,-29222,-29268,-29313,-29358,-29402,-29446,-29490,-29534,-29577,-29621,-29663,-29706,-29748,-29790,-29832,-29873,-29915,-29955,-29996,-30036,-30076,-30116,-30156,-30195,-30234,-30272,-30311,-30349,-30386,-30424,-30461,-30498,-30535,-30571,-30607,-30643,-30678,-30713,-30748,-30783,-30817,-30851,-30885,-30918,-30951,-30984,-31017,-31049,-31081,-31113,-31144,-31175,-31206,-31236,-31267,-31297,-31326,-31356,-31385,-31413,-31442,-31470,-31498,-31525,-31553,-31580,-31606,-31633,-31659,-31684,-31710,-31735,-31760,-31785,-31809,-31833,-31856,-31880,-31903,-31926,-31948,-31970,-31992,-32014,-32035,-32056,-32077,-32097,-32117,-32137,-32156,-32176,-32194,-32213,-32231,-32249,-32267,-32284,-32301,-32318,-32334,-32350,-32366,-32382,-32397,-32412,-32426,-32441,-32455,-32468,-32482,-32495,-32508,-32520,-32532,-32544,-32556,-32567,-32578,-32588,-32599,-32609,-32618,-32628,-32637,-32646,-32654,-32662,-32670,-32678,-32685,-32692,-32699,-32705,-32711,-32717,-32722,-32727,-32732,-32736,-32740,-32744,-32748,-32751,-32754,-32757,-32759,-32761,-32763,-32764,-32765,-32766,-32766,-32767,-32766,-32766,-32765,-32764,-32763,-32761,-32759,-32757,-32754,-32751,-32748,-32744,-32740,-32736,-32732,-32727,-32722,-32717,-32711,-32705,-32699,-32692,-32685,-32678,-32670,-32662,-32654,-32646,-32637,-32628,-32618,-32609,-32599,-32588,-32578,-32567,-32556,-32544,-32532,-32520,-32508,-32495,-32482,-32468,-32455,-32441,-32426,-32412,-32397,-32382,-32366,-32350,-32334,-32318,-32301,-32284,-32267,-32249,-32231,-32213,-32194,-32176,-32156,-32137,-32117,-32097,-32077,-32056,-32035,-32014,-31992,-31970,-31948,-31926,-31903,-31880,-31856,-31833,-31809,-31785,-31760,-31735,-31710,-31684,-31659,-31633,-31606,-31580,-31553,-31525,-31498,-31470,-31442,-31413,-31385,-31356,-31326,-31297,-31267,-31236,-31206,-31175,-31144,-31113,-31081,-31049,-31017,-30984,-30951,-30918,-30885,-30851,-30817,-30783,-30748,-30713,-30678,-30643,-30607,-30571,-30535,-30498,-30461,-30424,-30386,-30349,-30311,-30272,-30234,-30195,-30156,-30116,-30076,-30036,-29996,-29955,-29915,-29873,-29832,-29790,-29748,-29706,-29663,-29621,-29577,-29534,-29490,-29446,-29402,-29358,-29313,-29268,-29222,-29177,-29131,-29085,-29038,-28992,-28945,-28897,-28850,-28802,-28754,-28706,-28657,-28608,-28559,-28510,-28460,-28410,-28360,-28309,-28259,-28208,-28156,-28105,-28053,-28001,-27948,-27896,-27843,-27790,-27736,-27683,-27629,-27575,-27520,-27466,-27411,-27355,-27300,-27244,-27188,-27132,-27076,-27019,-26962,-26905,-26847,-26789,-26731,-26673,-26615,-26556,-26497,-26437,-26378,-26318,-26258,-26198,-26137,-26077,-26016,-25954,-25893,-25831,-25769,-25707,-25645,-25582,-25519,-25456,-25392,-25329,-25265,-25201,-25136,-25072,-25007,-24942,-24877,-24811,-24745,-24679,-24613,-24546,-24480,-24413,-24346,-24278,-24211,-24143,-24075,-24006,-23938,-23869,-23800,-23731,-23661,-23592,-23522,-23452,-23382,-23311,-23240,-23169,-23098,-23027,-22955,-22883,-22811,-22739,-22666,-22594,-22521,-22448,-22374,-22301,-22227,-22153,-22079,-22004,-21930,-21855,-21780,-21705,-21629,-21554,-21478,-21402,-21326,-21249,-21173,-21096,-21019,-20942,-20864,-20787,-20709,-20631,-20553,-20474,-20396,-20317,-20238,-20159,-20079,-20000,-19920,-19840,-19760,-19680,-19599,-19519,-19438,-19357,-19276,-19194,-19113,-19031,-18949,-18867,-18785,-18702,-18620,-18537,-18454,-18371,-18287,-18204,-18120,-18036,-17952,-17868,-17784,-17699,-17615,-17530,-17445,-17360,-17274,-17189,-17103,-17017,-16931,-16845,-16759,-16672,-16586,-16499,-16412,-16325,-16238,-16150,-16063,-15975,-15887,-15799,-15711,-15623,-15534,-15446,-15357,-15268,-15179,-15090,-15001,-14911,-14822,-14732,-14642,-14552,-14462,-14372,-14281,-14191,-14100,-14009,-13918,-13827,-13736,-13645,-13553,-13462,-13370,-13278,-13186,-13094,-13002,-12909,-12817,-12724,-12632,-12539,-12446,-12353,-12260,-12166,-12073,-11980,-11886,-11792,-11698,-11604,-11510,-11416,-11322,-11227,-11133,-11038,-10944,-10849,-10754,-10659,-10564,-10469,-10373,-10278,-10182,-10087,-9991,-9895,-9799,-9703,-9607,-9511,-9415,-9319,-9222,-9126,-9029,-8932,-8836,-8739,-8642,-8545,-8448,-8351,-8253,-8156,-8059,-7961,-7864,-7766,-7668,-7571,-7473,-7375,-7277,-7179,-7081,-6982,-6884,-6786,-6688,-6589,-6491,-6392,-6293,-6195,-6096,-5997,-5898,-5799,-5700,-5601,-5502,-5403,-5304,-5205,-5106,-5006,-4907,-4807,-4708,-4608,-4509,-4409,-4310,-4210,-4110,-4011,-3911,-3811,-3711,-3611,-3511,-3411,-3311,-3211,-3111,-3011,-2911,-2811,-2711,-2610,-2510,-2410,-2310,-2209,-2109,-2009,-1908,-1808,-1708,-1607,-1507,-1406,-1306,-1206,-1105,-1005,-904,-804,-703,-603,-502,-402,-301,-201,-100,0,100,201,301,402,502,603,703,804,904,1005,1105,1206,1306,1406,1507,1607,1708,1808,1908,2009,2109,2209,2310,2410,2510,2610,2711,2811,2911,3011,3111,3211,3311,3411,3511,3611,3711,3811,3911,4011,4110,4210,4310,4409,4509,4608,4708,4807,4907,5006,5106,5205,5304,5403,5502,5601,5700,5799,5898,5997,6096,6195,6293,6392,6491,6589,6688,6786,6884,6982,7081,7179,7277,7375,7473,7571,7668,7766,7864,7961,8059,8156,8253,8351,8448,8545,8642,8739,8836,8932,9029,9126,9222,9319,9415,9511,9607,9703,9799,9895,9991,10087,10182,10278,10373,10469,10564,10659,10754,10849,10944,11038,11133,11227,11322,11416,11510,11604,11698,11792,11886,11980,12073,12166,12260,12353,12446,12539,12632,12724,12817,12909,13002,13094,13186,13278,13370,13462,13553,13645,13736,13827,13918,14009,14100,14191,14281,14372,14462,14552,14642,14732,14822,14911,15001,15090,15179,15268,15357,15446,15534,15623,15711,15799,15887,15975,16063,16150,16238,16325,16412,16499,16586,16672,16759,16845,16931,17017,17103,17189,17274,17360,17445,17530,17615,17699,17784,17868,17952,18036,18120,18204,18287,18371,18454,18537,18620,18702,18785,18867,18949,19031,19113,19194,19276,19357,19438,19519,19599,19680,19760,19840,19920,20000,20079,20159,20238,20317,20396,20474,20553,20631,20709,20787,20864,20942,21019,21096,21173,21249,21326,21402,21478,21554,21629,21705,21780,21855,21930,22004,22079,22153,22227,22301,22374,22448,22521,22594,22666,22739,22811,22883,22955,23027,23098,23169,23240,23311,23382,23452,23522,23592,23661,23731,23800,23869,23938,24006,24075,24143,24211,24278,24346,24413,24480,24546,24613,24679,24745,24811,24877,24942,25007,25072,25136,25201,25265,25329,25392,25456,25519,25582,25645,25707,25769,25831,25893,25954,26016,26077,26137,26198,26258,26318,26378,26437,26497,26556,26615,26673,26731,26789,26847,26905,26962,27019,27076,27132,27188,27244,27300,27355,27411,27466,27520,27575,27629,27683,27736,27790,27843,27896,27948,28001,28053,28105,28156,28208,28259,28309,28360,28410,28460,28510,28559,28608,28657,28706,28754,28802,28850,28897,28945,28992,29038,29085,29131,29177,29222,29268,29313,29358,29402,29446,29490,29534,29577,29621,29663,29706,29748,29790,29832,29873,29915,29955,29996,30036,30076,30116,30156,30195,30234,30272,30311,30349,30386,30424,30461,30498,30535,30571,30607,30643,30678,30713,30748,30783,30817,30851,30885,30918,30951,30984,31017,31049,31081,31113,31144,31175,31206,31236,31267,31297,31326,31356,31385,31413,31442,31470,31498,31525,31553,31580,31606,31633,31659,31684,31710,31735,31760,31785,31809,31833,31856,31880,31903,31926,31948,31970,31992,32014,32035,32056,32077,32097,32117,32137,32156,32176,32194,32213,32231,32249,32267,32284,32301,32318,32334,32350,32366,32382,32397,32412,32426,32441,32455,32468,32482,32495,32508,32520,32532,32544,32556,32567,32578,32588,32599,32609,32618,32628,32637,32646,32654,32662,32670,32678,32685,32692,32699,32705,32711,32717,32722,32727,32732,32736,32740,32744,32748,32751,32754,32757,32759,32761,32763,32764,32765,32766,32766};

/*! \brief
//  Filtering function for UFMC waveform 
//  Carmine Vitiello , 05/2015
//  mail: carmine.vitiello@for.unipi.it
//  
*/

double cheby_poly(int n, double x){ //chebyshev polyomial T_n(x)
    double res;
    if (fabs(x) <= 1) res = cos(n*acos(x));
    else              res = cosh(n*acosh(x));
    return res;
}

/***************************************************************************
 calculate a Dolph-Chebyshev window of size N, store coeffs in out as in A.Antoniou - "Digital Filters" - 2000 - McGrawHill
- out should be a float array of size N 
- atten is the required sidelobe attenuation (e.g. if you want -60dB atten, use '60')
 P.S.: Results are equal to matlab/octave algorithm, which operate in frequency domain, with slight difference for even filter order
***************************************************************************/
void f_cheby_win(float *out, int N, float atten){ //Floating-point real taps Dolph-Chebyshev filter
    int nn, i;
    double M, n, sum = 0, max=0;
    double tg = pow(10,atten/20);  /* 1/r term [2], 10^gamma [2] */
    double x0 = cosh((1.0/(N-1))*acosh(tg));
    M = (N-1)/2;
    if(N%2==0) M = M + 0.5; /* handle even length windows */
    for(nn=0; nn<(N/2+1); nn++){
        n = nn-M;
        sum = 0;
        for(i=1; i<=M; i++){
            sum += cheby_poly(N-1,x0*cos(PI*i/N))*cos(2.0*n*PI*i/N);
        }
        *(out+nn) = tg + 2*sum;
        *(out+N-nn-1) = *(out+nn);
        if(out[nn]>max)max=out[nn];
    }
    for(nn=0; nn<N; nn++) *(out+nn) /= (max*N); /* normalise everything */
    return;
}

void i_cheby_win(int16_t *out, int N, float atten){ //Fixed-point real taps Dolph-Chebyshev filter
    int nn, i;
    float y[N];
    double M, n, sum = 0, max=0, norm=0;
    double tg = pow(10,atten/20);  /* 1/r term [2], 10^gamma [2] */
    double x0 = cosh((1.0/(N-1))*acosh(tg));
    M = (N-1)/2;
    if(N%2==0) M = M + 0.5; /* handle even length windows */
    for(nn=0; nn<(N/2+1); nn++){
        n = nn-M;
        sum = 0;
        for(i=1; i<=M; i++){
            sum += cheby_poly(N-1,x0*cos(PI*i/N))*cos(2.0*n*PI*i/N);
        }
        y[nn] = tg + 2*sum;
        y[N-nn-1] = y[nn];
	norm+=y[nn];
        if(y[nn]>max)max=y[nn];
    }
    printf("cheb_win: max %f, norm %f\n",max,norm);
    for(nn=0; nn<N; nn++) {
      *(out+nn) = (int16_t)((y[nn]/ (max*2))*((1<<15)-1)); // normalise everything and scale 
      //*(out+nn) = (int16_t)((y[nn]/ (norm))*((1<<15)-1)); // normalise everything and scale 
    }
    return;
}
/***************************************************************************
Vector Multiplication SIMD
***************************************************************************/

static short reflip[8]  __attribute__((aligned(16))) = {1,-1,1,-1,1,-1,1,-1};  
short conjug75[8]__attribute__((aligned(16))) = {-1,1,-1,1,-1,1,-1,1};

void multcmplx(int16_t *out,int16_t *fact1,int16_t *fact2,int16_t lIN){
  /*!\fn void multcmplx_add(int16_t *out,int16_t *fact1,int16_t *fact2,int16_t lIN)
This function performs multiplication between complex vector fact1 and fact2 and store the result into out
@param out Output vector (Q1.15) in the format  |Re0  Im0|, |Re1 Im1|,......,|Re(N-1) Im(N-1)|
@param fact1 Factor 1 vector (Q1.15) in the format  |Re0  Im0|, |Re1 Im1|,......,|Re(N-1) Im(N-1)|
@param fact2 Factor 2 vector (Q1.15) in the format  |Re0  Im0|, |Re1 Im1|,......,|Re(N-1) Im(N-1)|
@param N Length of x WARNING: N>=8

The function implemented is : \f$\mathbf{out} = \mathbf{fact1} * \mathbf{fact2}\f$
*/
  int16_t i;
  //int16_t *temps;
  __m128i mmtmpD0,mmtmpD1,mmtmpD2,mmtmpD3;
  __m128i *inX,*outX,*vec;
  outX= (__m128i *)&out[0];
  inX=(__m128i *)&fact1[0];
  vec=(__m128i *)&fact2[0];
  for(i=0;i<lIN>>2;i++){
    //temps = (int16_t *)inX;
    //printf("inX : %d,%d,%d,%d,%d,%d,%d,%d\n",temps[0],temps[1],temps[2],temps[3],temps[4],temps[5],temps[6],temps[7]);
    // Real part
    // mmtmpD0 contains real part of 4 consecutive outputs (32-bit)
    mmtmpD0 = _mm_madd_epi16(vec[0],_mm_sign_epi16(inX[0],*(__m128i*)&reflip[0]));
    mmtmpD1 = _mm_shufflelo_epi16(vec[0],_MM_SHUFFLE(2,3,0,1));
    mmtmpD1 = _mm_shufflehi_epi16(mmtmpD1,_MM_SHUFFLE(2,3,0,1));
    //mmtmpD1 = _mm_sign_epi16(mmtmpD1,*(__m128i*)&conjugate[0]);
    // Imaginary part
    // mmtmpD1 contains imag part of 4 consecutive outputs (32-bit)
    mmtmpD1 = _mm_madd_epi16(mmtmpD1,inX[0]);
    // take higher 15 bit
    mmtmpD0 = _mm_srai_epi32(mmtmpD0,15);
    mmtmpD1 = _mm_srai_epi32(mmtmpD1,15);
    // pack
    mmtmpD2 = _mm_unpacklo_epi32(mmtmpD0,mmtmpD1);
    mmtmpD3 = _mm_unpackhi_epi32(mmtmpD0,mmtmpD1);
    outX[0] = _mm_packs_epi32(mmtmpD2,mmtmpD3);
    // Increase the pointers
    outX+=1;
    inX+=1;
    vec+=1;
  } 
}


void mux_7_5(int32_t*out,int32_t*in,int32_t*shift,uint16_t len){
   /*!\fn void mux_7_5(int32_t*out,int32_t*in,int32_t*shift,uint16_t len)
This function performs same operation of apply_7_5_kHz in PHY/MOLDULATIN
@param out Output vector (Q1.15) in the format  |Re0  Im0|, |Re1 Im1|,......,|Re(N-1) Im(N-1)|
@param in input vector (Q1.15) in the format  |Re0  Im0|, |Re1 Im1|,......,|Re(N-1) Im(N-1)|
@param shift shifting vector (Q1.15) in the format  |Re0  Im0|, |Re1 Im1|,......,|Re(N-1) Im(N-1)|
@param N Length of x WARNING: N>=8
\f$
*/
  __m128i *txptr128,*kHz7_5ptr128,*outptr128,mmtmp_re,mmtmp_im,mmtmp_re2,mmtmp_im2;
  txptr128 = (__m128i *)in;
  kHz7_5ptr128 = (__m128i *)shift;
  outptr128 = (__m128i *)out;
  uint32_t i;
  for (i=0; i<(len>>2); i++) {
    mmtmp_re = _mm_madd_epi16(*txptr128,*kHz7_5ptr128);
    // Real part of complex multiplication (note: 7_5kHz signal is conjugated for this to work)
    mmtmp_im = _mm_shufflelo_epi16(*kHz7_5ptr128,_MM_SHUFFLE(2,3,0,1));
    mmtmp_im = _mm_shufflehi_epi16(mmtmp_im,_MM_SHUFFLE(2,3,0,1));
    mmtmp_im = _mm_sign_epi16(mmtmp_im,*(__m128i*)&conjug75[0]);
    mmtmp_im = _mm_madd_epi16(mmtmp_im,txptr128[0]);
    mmtmp_re = _mm_srai_epi32(mmtmp_re,15);
    mmtmp_im = _mm_srai_epi32(mmtmp_im,15);
    mmtmp_re2 = _mm_unpacklo_epi32(mmtmp_re,mmtmp_im);
    mmtmp_im2 = _mm_unpackhi_epi32(mmtmp_re,mmtmp_im);

    outptr128[0] = _mm_packs_epi32(mmtmp_re2,mmtmp_im2);
    txptr128++;
    kHz7_5ptr128++;
    outptr128++;
  }
}

void multcmplx_add(int16_t *out,int16_t *fact1,int16_t *fact2,int16_t lIN){
  /*!\fn void multcmplx_add(int16_t *out,int16_t *fact1,int16_t *fact2,int16_t lIN)
This function performs multiplication between complex vector fact1 and fact2 and store the result into out, summing with the previous value
@param out Output vector (Q1.15) in the format  |Re0  Im0|, |Re1 Im1|,......,|Re(N-1) Im(N-1)|
@param fact1 Factor 1 vector (Q1.15) in the format  |Re0  Im0|, |Re1 Im1|,......,|Re(N-1) Im(N-1)|
@param fact2 Factor 2 vector (Q1.15) in the format  |Re0  Im0|, |Re1 Im1|,......,|Re(N-1) Im(N-1)|
@param N Length of x WARNING: N>=8

The function implemented is : \f$\mathbf{out} = out + (\mathbf{fact1} * \mathbf{fact2})\f$
*/
  int16_t i;
  //int16_t *temps;
  __m128i mmtmpD0,mmtmpD1,mmtmpD2,mmtmpD3;
  __m128i *inX,*outX,*vec;
  outX= (__m128i *)&out[0];
  inX=(__m128i *)&fact1[0];
  vec=(__m128i *)&fact2[0];
  for(i=0;i<lIN>>2;i++){
    //temps = (int16_t *)inX;
    //printf("inX : %d,%d,%d,%d,%d,%d,%d,%d\n",temps[0],temps[1],temps[2],temps[3],temps[4],temps[5],temps[6],temps[7]);
    // Real part
    // mmtmpD0 contains real part of 4 consecutive outputs (32-bit)
    mmtmpD0 = _mm_madd_epi16(vec[0],_mm_sign_epi16(inX[0],*(__m128i*)&reflip[0]));
    mmtmpD1 = _mm_shufflelo_epi16(vec[0],_MM_SHUFFLE(2,3,0,1));
    mmtmpD1 = _mm_shufflehi_epi16(mmtmpD1,_MM_SHUFFLE(2,3,0,1));
    //mmtmpD1 = _mm_sign_epi16(mmtmpD1,*(__m128i*)&conjugate[0]);
    // Imaginary part
    // mmtmpD1 contains imag part of 4 consecutive outputs (32-bit)
    mmtmpD1 = _mm_madd_epi16(mmtmpD1,inX[0]);
    // take higher 15 bit
    mmtmpD0 = _mm_srai_epi32(mmtmpD0,15);
    mmtmpD1 = _mm_srai_epi32(mmtmpD1,15);
    // pack
    mmtmpD2 = _mm_unpacklo_epi32(mmtmpD0,mmtmpD1);
    mmtmpD3 = _mm_unpackhi_epi32(mmtmpD0,mmtmpD1);
    outX[0] = _mm_adds_epi16(outX[0] ,_mm_packs_epi32(mmtmpD2,mmtmpD3)); //is necessary shift right to 1? _mm_srai_epi16(,1)
    // Increase the pointers
    outX+=1;
    inX+=1;
    vec+=1;
  } 
}

void multcmplx_conj(int16_t *out,int16_t *fact1,int16_t *fact2,int16_t lIN,uint8_t right_shift){
  /*!\fn void multcmplx_add(int16_t *out,int16_t *fact1,int16_t *fact2,int16_t lIN)
This function performs multiplication between complex vector fact1 and fact2 and store the result into out
@param out Output vector (Q1.15) in the format  |Re0  Im0|, |Re1 Im1|,......,|Re(N-1) Im(N-1)|
@param fact1 Factor 1 vector (Q1.15) in the format  |Re0  Im0|, |Re1 Im1|,......,|Re(N-1) Im(N-1)|
@param fact2 Factor 2 vector (Q1.15) in the format  |Re0  Im0|, |Re1 Im1|,......,|Re(N-1) Im(N-1)|
@param lIN Length of x WARNING: N>=8
@param right_shift bit of right shift after multiplication

The function implemented is : \f$\mathbf{out} = \mathbf{fact1} * \mathbf{fact2}\f$
*/
  int16_t i;
  __m128i mmtmpD0,mmtmpD1,mmtmpD2,mmtmpD3;
  __m128i *inX,*outX,*vec;
  outX= (__m128i *)&out[0];
  inX=(__m128i *)&fact1[0];
  vec=(__m128i *)&fact2[0];
  for(i=0;i<lIN>>2;i++){
    // temps = (int16_t *)inX;
    // printf("inX : %d,%d,%d,%d,%d,%d,%d,%d\n",temps[0],temps[1],temps[2],temps[3],temps[4],temps[5],temps[6],temps[7]);
    // Real part
    // mmtmpD0 contains real part of 4 consecutive outputs (32-bit)
    mmtmpD0 = _mm_madd_epi16(vec[0],inX[0]);
    mmtmpD1 = _mm_shufflelo_epi16(vec[0],_MM_SHUFFLE(2,3,0,1));
    mmtmpD1 = _mm_shufflehi_epi16(mmtmpD1,_MM_SHUFFLE(2,3,0,1));
    mmtmpD1 = _mm_sign_epi16(mmtmpD1,*(__m128i*)&reflip[0]);
    // Imaginary part
    // mmtmpD1 contains imag part of 4 consecutive outputs (32-bit)
    mmtmpD1 = _mm_madd_epi16(mmtmpD1,inX[0]);
    // take higher 15 bit
    mmtmpD0 = _mm_srai_epi32(mmtmpD0,right_shift);// 15 
    mmtmpD1 = _mm_srai_epi32(mmtmpD1,right_shift);// 15
    // pack
    mmtmpD2 = _mm_unpacklo_epi32(mmtmpD0,mmtmpD1);
    mmtmpD3 = _mm_unpackhi_epi32(mmtmpD0,mmtmpD1);
    outX[0] = _mm_packs_epi32(mmtmpD2,mmtmpD3);
    // Increase the pointers
    outX+=1;
    inX+=1;
    vec+=1;
  } 
}

void multcmplx_conj_add(int16_t *out,int16_t *fact1,int16_t *fact2,int16_t lIN){
  /*!\fn void multcmplx_add(int16_t *out,int16_t *fact1,int16_t *fact2,int16_t lIN)
This function performs multiplication between complex vector fact1 and fact2 and store the result into out, summing with the previous value
@param out Output vector (Q1.15) in the format  |Re0  Im0|, |Re1 Im1|,......,|Re(N-1) Im(N-1)|
@param fact1 Factor 1 vector (Q1.15) in the format  |Re0  Im0|, |Re1 Im1|,......,|Re(N-1) Im(N-1)|
@param fact2 Factor 2 vector (Q1.15) in the format  |Re0  Im0|, |Re1 Im1|,......,|Re(N-1) Im(N-1)|
@param N Length of x WARNING: N>=8

The function implemented is : \f$\mathbf{out} = out + (\mathbf{fact1} * \mathbf{fact2})\f$
*/
  int16_t i;
  //int16_t *temps;
  __m128i mmtmpD0,mmtmpD1,mmtmpD2,mmtmpD3;
  __m128i *inX,*outX,*vec;
  outX= (__m128i *)&out[0];
  inX=(__m128i *)&fact1[0];
  vec=(__m128i *)&fact2[0];
  for(i=0;i<lIN>>2;i++){
    //temps = (int16_t *)inX;
    //printf("inX : %d,%d,%d,%d,%d,%d,%d,%d\n",temps[0],temps[1],temps[2],temps[3],temps[4],temps[5],temps[6],temps[7]);
    // Real part
    // mmtmpD0 contains real part of 4 consecutive outputs (32-bit)
   mmtmpD0 = _mm_madd_epi16(vec[0],inX[0]);
    mmtmpD1 = _mm_shufflelo_epi16(vec[0],_MM_SHUFFLE(2,3,0,1));
    mmtmpD1 = _mm_shufflehi_epi16(mmtmpD1,_MM_SHUFFLE(2,3,0,1));
    mmtmpD1 = _mm_sign_epi16(mmtmpD1,*(__m128i*)&reflip[0]);
    // Imaginary part
    // mmtmpD1 contains imag part of 4 consecutive outputs (32-bit)
    mmtmpD1 = _mm_madd_epi16(mmtmpD1,inX[0]);
    // take higher 15 bit
    mmtmpD0 = _mm_srai_epi32(mmtmpD0,15);
    mmtmpD1 = _mm_srai_epi32(mmtmpD1,15);
    // pack
    mmtmpD2 = _mm_unpacklo_epi32(mmtmpD0,mmtmpD1);
    mmtmpD3 = _mm_unpackhi_epi32(mmtmpD0,mmtmpD1);
    outX[0] = _mm_adds_epi16(outX[0] ,_mm_packs_epi32(mmtmpD2,mmtmpD3)); //is necessary shift right to 1? _mm_srai_epi16(,1)
    // Increase the pointers
    outX+=1;
    inX+=1;
    vec+=1;
  } 
}

void square_abs_cmplx_add(int32_t *out,int16_t *fact1,int16_t lIN){
  /*!\fn square_abs_cmplx_add(int32_t *out,int16_t *fact1,int16_t *fact2,int16_t lIN)
This function performs square absolute value of complex vector fact1(int16) storing the result into out(32bit), summing with the previous value
@param out Output vector (Q1.15) in the format  |Re0  Im0|, |Re1 Im1|,......,|Re(N-1) Im(N-1)|
@param fact1 Factor 1 vector (Q1.15) in the format  |Re0  Im0|, |Re1 Im1|,......,|Re(N-1) Im(N-1)|
@param N Length of x WARNING: N>=8

The function implemented is : \f$\mathbf{out} = out + (abs(\mathbf{fact1}) ^ 2 )\f$
*/
  int16_t i;
  //int16_t *temps;
  __m128i mmtmpD0; 
  __m128i *inX,*outX;
  outX= (__m128i *)&out[0];
  inX=(__m128i *)&fact1[0];
  for(i=0;i<lIN>>2;i++){
    //temps = (int16_t *)inX;
    //printf("inX : %d,%d,%d,%d,%d,%d,%d,%d\n",temps[0],temps[1],temps[2],temps[3],temps[4],temps[5],temps[6],temps[7]);
    // Real part
    // mmtmpD0 contains 4 consecutive outputs (32-bit) of square absolute value
    mmtmpD0 = _mm_madd_epi16(inX[0],inX[0]); 
    // take higher 15 bit
    //mmtmpD0 = _mm_srai_epi32(mmtmpD0,15);
    // sum to the other 32 bit output
    outX[0] = _mm_add_epi32(outX[0] , mmtmpD0); //is necessary shift right to 1? _mm_srai_epi32(,1)
    // Increase the pointers
    outX+=1;
    inX+=1;
  } 
}

int32_t sum_square_abs_cmplx_SIMD(int16_t *fact1,int16_t lIN){
  /*!\fn square_abs_cmplx_add(int32_t *out,int16_t *fact1,int16_t *fact2,int16_t lIN)
This function performs square absolute value of complex vector fact1(int16), summing elements and returning the result in int_32
@param fact1 Factor 1 vector (Q1.15) in the format  |Re0  Im0|, |Re1 Im1|,......,|Re(N-1) Im(N-1)|
@param N Length of x WARNING: N>=8

The function implemented is : \f$\mathbf{out} = out + (abs(\mathbf{fact1}) ^ 2 )\f$
*/
  int16_t i;
  int32_t *temps;
  __m128i mmtmpD0;
  __m128i *inX;
  inX=(__m128i *)fact1;
  int32_t counter=0;
  for(i=0;i<lIN>>2;i++){
    // mmtmpD0 contains 4 consecutive outputs (32-bit) of square absolute value
    mmtmpD0 = _mm_madd_epi16(inX[0],inX[0]); 
    temps = (int32_t *)&mmtmpD0;
    counter+=(temps[0]+temps[1]+temps[2]+temps[3]);
    // Increase the pointers
    inX+=1;
  } 
  return (int32_t)counter/lIN;
}

int32_t sum_square_abs_cmplx(int16_t *fact,int16_t lIN){
  /*!\fn square_abs_cmplx_add(int32_t *out,int16_t *fact1,int16_t *fact2,int16_t lIN)
This function performs square absolute value of complex vector fact1(int16), summing elements and returning the result in int_32
@param fact1 Factor 1 vector (Q1.15) in the format  |Re0  Im0|, |Re1 Im1|,......,|Re(N-1) Im(N-1)|
@param N Length of x WARNING: N>=8

The function implemented is : \f$\mathbf{out} = out + (abs(\mathbf{fact1}) ^ 2 )\f$
*/
  int16_t i;
  int32_t counter=0;
  for(i=0;i<lIN;i++){
    counter+=((int32_t)(fact[i<<1]*fact[i<<1])+(int32_t)(fact[(i<<1)+1]*fact[(i<<1)+1]));
    // Increase the pointers
  } 
  return (int32_t)counter/lIN;
}

int max_vec(int32_t *in,uint16_t lin){
  /*
   * This function finds the index of maximum value in vector in(integer value) with length lin
   */
  uint16_t i,index_v;
  int32_t max_v;
  //  int32_t value[lin>>1];
  index_v=0;
  max_v=in[0];
  for(i=0;i<lin;i++){
    //    value[i]=abs_v;
    max_v = (max_v>in[i]) ? max_v : in[i]; 
    index_v = (max_v>in[i]) ? index_v : i;
  }
  //write_output("AbsVector.m","AbsVec",value,lin>>1,1,0);
  return index_v;
}

/***************************************************************************
Upsampling Operation
***************************************************************************/

void ff_UpSampler(float *in, float *out, uint16_t lIN, uint16_t Up_factor){ //Upsamping float input float output
  uint16_t i;
  memset(out,0,lIN*Up_factor*sizeof(int16_t));
  for (i=0;i<lIN;i++){
    *(out+i*Up_factor)=*(in+i);
  }
}
void ii_UpSampler(int16_t *in, int16_t *out, uint16_t lIN, uint16_t Up_factor){ //Upsampling fixedpoint 16 bit input & output
  uint16_t i;
  memset(out,0,lIN*Up_factor*sizeof(int16_t));
  for (i=0;i<lIN;i++){
    *(out+i*Up_factor)=*(in+i);
  }
}
void ff_complex_UpSampler(float *in, float *out, uint16_t lIN, uint16_t Up_factor){ //Upsampling fixedpoint 16 bit input & output
  uint16_t i;
  memset(out,0,2*lIN*Up_factor*sizeof(float));
  for (i=0;i<lIN;i++){
    *(out+i*Up_factor)=*(in+i);
    *(out+i*Up_factor+1)=*(in+i+1);
  }
}
void ii_complex_UpSampler(int16_t *in, int16_t *out, uint16_t lIN, uint16_t Up_factor){ //Upsampling fixedpoint 16 bit input & output
  uint16_t i;
  memset(out,0,2*lIN*Up_factor*sizeof(int16_t));
  for (i=0;i<lIN;i++){
    *(out+i*Up_factor)=*(in+i);
    *(out+i*Up_factor+1)=*(in+i+1);
  }
}

/***************************************************************************
Upsampling Filtering Operation
***************************************************************************/

void ff_UpFilter(float *in, float *out , uint16_t lIN, float *hFIR , uint16_t lFIR, uint16_t Up_factor){ //Upsampling filter in floating point
  uint16_t i,j;
  for (i=0;i<(lIN*Up_factor+lFIR-1);i++){
    *(out+i)=0.0;
  }
  for (i=0;i<lIN;i++){
    for(j=0;j<lFIR;j++){
      *(out+i*Up_factor+j)+=(*(in+i))*(*(hFIR+j));
    }
  }
}

void ii_complx_UpFilter(int16_t *in, int16_t *out , uint16_t lIN, int16_t *hFIR , uint32_t lFIR, uint16_t Up_factor){ //Filtering function 
  // Processing on output, fixed input
  uint16_t i;
  memset(out,0,((lIN*Up_factor)+lFIR-1)*2*sizeof(int16_t));
  for (i=0;i<lIN;i++){
    multadd_real_vector_complex_scalar(hFIR,//*x-->filter length must be multiple of 8
                                        &in[i<<1],//alpha
                                        &out[Up_factor * (i<<1)],//*y
                                        lFIR);//N
  }
}

/***************************************************************************
Modulation Operation
***************************************************************************/
void CreateModvec(uint16_t n_rb,// number of resource block
		  uint16_t first_rb,// number of resource block
		  uint32_t FFTsize, //FFTsize
		  uint32_t size_l,
		  float *mod_vec){
  uint16_t i;
  float carrierind =(first_rb+12*(n_rb-1))+(float)(12+1)/2;
  for(i=0;i<size_l;i+=2){
     *(mod_vec+i)=(float)cos((float)2*PI*i*(carrierind-1)/FFTsize);
     *(mod_vec+i+1)=(float)sin((float)2*PI*i*(carrierind-1)/FFTsize);
  }
}

int16_t mod_vec[100][2560]  __attribute__((aligned(32)));

int ii_CreateModvec(uint16_t n_rb,// current resource block index
		    uint16_t first_carrier,// first subcarrier offset
		    uint32_t FFTsize, //FFTsize
		    uint32_t size_l, //array dimension
		    int16_t *mod_vec) //output array
{
  int16_t i,M=FFTsize/4;
  int16_t *cos_tab;
  int16_t carrierind = first_carrier+12*n_rb+6; //+6 should be replaced by (total number of RBs)/2, but we do not have this number at this point. 

  // FK: handle wraparound
  if (carrierind >= FFTsize)
    carrierind = carrierind-FFTsize;

  switch(FFTsize){
    case 128:
      cos_tab=cos_tab_128;
      break;
    case 256:
      cos_tab=cos_tab_256;
      break;
    case 512:
      cos_tab=cos_tab_512;
      break;
    case 1024:
      cos_tab=cos_tab_1024;
      break;
    case 1536:
      cos_tab=cos_tab_1536;
      break;
    case 2048:
      cos_tab=cos_tab_2048;
      break;
  default:
    LOG_E(PHY,"Bad FFT size\n");
    return(-1);
  }
  //write_output("cosine.m","cosine", cos_tab,FFTsize,1,0);
  for(i=0;i<size_l;i++){
    *(mod_vec+(i<<1))   = cos_tab[(i*carrierind)%FFTsize];
    *(mod_vec+(i<<1)+1) = cos_tab[(M-i*carrierind)%FFTsize]; //sin(x) = cos(pi/2-x);
  }
  return(0);
}


/***************************************************************************
UFMC Modulation - Upsampling+Dolph-Chebyshev+FrequencyShilfting
***************************************************************************/

int16_t hFIR[152]  __attribute__((aligned(32))); // 152 is closest multiple of 8 to 145

void ufmc_init(LTE_DL_FRAME_PARMS *frame_parms)
{

  float atten=60;
  uint16_t FFT_size=frame_parms->ofdm_symbol_size;
  uint16_t lFIR=frame_parms->nb_prefix_samples;
  uint16_t prefix_len0=frame_parms->nb_prefix_samples0;
  uint16_t first_carrier=frame_parms->first_carrier_offset;
  uint16_t lOUT,lFIR_padded;
  uint16_t n_rb,n_rb_max=frame_parms->N_RB_UL;

  //lFIR has to be a multiple of 8, so round down if necessary (cannot round up since this will create memory overflow)
  lFIR_padded = (lFIR/8)*8;
  lOUT=(FFT_size+prefix_len0); //output length(complex);
  /*
  if ((lFIR%0x0A)>0){ //lFIR!=10 || lFIR!=20 || lFIR!=40 || lFIR!=80 || lFIR!=120 || lFIR!=160 longer prefix from 1st symbol
    lFIR+=1;                   // 37 for 25 PRB, 73 for 50 PRB, 145 for 100 PRB
  }else{
    lFIR=(0x09*(lFIR/0x0A))+1; // bring down to : 37 for 25 PRB, 73 for 50 PRB, 145 for 10 PRB
  }
  quotient=lFIR/8;
  lFIR_padded = (lFIR%8)>0 ? (quotient+2)<<3 : quotient<<3; //CV: extended padded length by 16 samples more
  */

  // Filter Impulse Response creation
  printf("length fir=%d,length fir padded=%d\n",lFIR,lFIR_padded);
  memset(hFIR,0,lFIR_padded*sizeof(int16_t));
  i_cheby_win(hFIR, lFIR_padded, atten);
  write_output("h_filter.m","h_filter",hFIR,lFIR_padded,1,0);
  for (n_rb=0;n_rb<n_rb_max;n_rb++) {
    ii_CreateModvec(n_rb,first_carrier,FFT_size,lOUT,&mod_vec[n_rb][0]);
    //write_output("mod_vec.m","mod_vec",mod_vec, lOUT>>1,1,1);
  }
}

void dolph_cheb(int16_t *in, // input array-->length=(size+lFIR)*2
		int16_t *out, // output array-->length=(FFT_size+lFIR)*2
		uint16_t lFIR,  // FIR length(multiple of 8)
		uint16_t lFIR_padded, //prefix length (has to be <= lFIR)
		int size, // input dimension(only real part) -> FFT dimension
		int FFT_size, // dimensione of standard FFT
		int n_rb, //current resource block index 
		int first_carrier //first subcarrier offset
	       ) 
{
  
  uint16_t Up_factor=FFT_size/size, //Upsampling factor-->multiple of 4
	   lOUT2;


  //FK: I was not sure what the following 3 lines are supposed to do, so I added lFIR_padded as an input parameter
  //lFIR++;
  //quotient=(int)lFIR/8;
  //lFIR_padded = (quotient+1)<<3;
  lOUT2=(FFT_size+lFIR_padded)<<1; //filter output length (complex);
  //printf("lOUT=%d,lFIR=%d,lFIR_padded=%d,lOUT2=%d\n",lOUT,lFIR,lFIR_padded,lOUT2);
  int16_t out2[lOUT2] __attribute__((aligned(32)));
  memset(out2,0,lOUT2*sizeof(int16_t));
  // Upsampling and Filtering
  ii_complx_UpFilter(&in[0],&out2[0], size, &hFIR[0] , lFIR, Up_factor);
  //write_output("FIR_out.m","fir",out2, lOUT2>>1,1,1);
  // Modulation
  //memset(out,0,lOUT2*sizeof(int16_t));
  multcmplx_add(&out[0],&out2[0],&mod_vec[n_rb][0],lOUT2>>1);
}

#ifdef MAIN

main()
{
  uint32_t lFIR=72; //filter length but see as cyclic prefix length --> 72 or 80
  uint16_t lIN=32, //length of only real part-->length of reduced FFT
	   FFT_size=1<<10, //length of entire FFT
	   Up_factor=FFT_size/lIN, //Upsampling factor-->multiple of 4
	   lOUT=(FFT_size+lFIR)*2, //output length
	   nb_rb=1; //first resource block (for frequency shifting)
  int16_t in1[2*lIN],in[2*lIN],out[lOUT];
  int16_t i;    

  // Random generation of source bit
  memset(in1,0,(lIN<<1)*sizeof(int16_t));
  for(i=0;i<lIN<<1;i+=2){
    in1[i<<1]=(rand()-(RAND_MAX>>1))>0 ? -32768 : 32767; //BPSK
  }
  
  idft64(&in1[0],&in[0],1);
  
  // Upsampling+Filtering+FrequencyShifting
  dolph_cheb(&in[0], // input
	     &out[0], // output
	     lFIR,  // (nb_prefix_samples)cyclic prefix length -> it becomes FIR length(multiple of 8)
	     lIN, // input dimension(only real part) -> FFT dimension
	     FFT_size,
	     nb_rb //first resource block index 
	       );
  // storing into file
  //write_output("Output.m","Output",out,lOUT,1,1);
  
}
#endif
